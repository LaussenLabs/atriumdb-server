##
## AtriumDB is a timeseries database software designed to best handle the unique
## features and challenges that arise from clinical waveform data.
##
## Copyright (c) 2025 The Hospital for Sick Children.
##
## This file is part of AtriumDB 
## (see atriumdb.io).
##
## This program is free software: you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation, either version 3 of the License, or
## (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this program. If not, see <http://www.gnu.org/licenses/>.
##

services:
  tsc-generator:
    image: atriumdb/atriumdb-server:1.2.0
    command: ./atriumdb-server --tsc-gen
#    restart: always
    # set internal path you want tsc and wal files to sit at. Also mount code directory so its easy to change without
    # container rebuild. Format is host/path:container/path
    volumes:
      - ../../tsc_generator:/src/tsc_generator
      - ./data/tsc:/data/tsc
      - ./data/wal:/data/wal
      - ../config_example.yaml:/config.yaml
      - ../secrets_example.yaml:/secrets.yaml
    depends_on:
      mariadb:
        condition: service_healthy

  wal-writer:
    image: atriumdb/atriumdb-server:1.2.0
    command: ./atriumdb-server --wal-writer
    # Set internal path where you want wal files stored format is host/path:container/path
    volumes:
      - ../../wal_writer:/src/wal_writer
      - ./data/wal:/data/wal
      - ../config_example.yaml:/config.yaml
      - ../secrets_example.yaml:/secrets.yaml
    #    restart: always
    depends_on:
      rabbitMQ:
        condition: service_healthy
      mariadb:
        condition: service_healthy
      siridb:
        condition: service_healthy

  atriumdb-api:
    image: atriumdb/atriumdb-server:1.2.0
    command: ./atriumdb-server --rest-api --uvicorn-num-workers 1
    env_file:
      - ../example_api.env
    ports:
      - 89:80
    volumes:
      - ../../rest_api:/src/rest_api
      - ./data/tsc:/data/tsc
    depends_on:
      mariadb:
        condition: service_healthy
      siridb:
        condition: service_healthy

  # if you want bundled rabbitMQ container
  rabbitMQ:
    image: rabbitmq:3-management
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 0s
    restart: always
    ports:
      - 5672:5672
      - 15672:15672

  siridb:
    image: ghcr.io/siridb/siridb-server:latest
    ports:
      - 127.0.0.1:8080:8080
      - 9000:9000
      - 127.0.0.1:9080:9080
    volumes:
      - ./data/siridb:/var/lib/siridb
    environment:
      SIRIDB_OPTIMIZING_INTERVAL: 3600
    healthcheck:
      test: [ "CMD", "wget", "-q", "-O", "-", "http://localhost:8080/healthy"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 0s
    restart: always

  mariadb:
    image: mariadb:latest
    restart: always
    volumes:
      - ./data/mariadb:/var/lib/mysql
    environment:
      MARIADB_ROOT_PASSWORD: example
      MARIADB_MYSQL_LOCALHOST_USER: 1
      MARIADB_PASSWORD: maria
      MARIADB_USER: maria
      MARIADB_DATABASE: atriumdb-dev
    ports:
      - 3306:3306
    healthcheck:
      test: /usr/local/bin/healthcheck.sh --su mysql --connect
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 0s

  adminer:
    image: adminer:latest
    restart: always
    ports:
      - 8090:8080